<!DOCTYPE html>
<html>
<body>
<script src="../resources/runner.js"></script>
<script>

var canvas = document.createElement("canvas");
var gl = canvas.getContext("webgl2");
let vsText = `
precision highp float;
attribute vec2 a_position;
uniform vec2 u_resolution;
void main() {
    vec2 clipSpace = (a_position / u_resolution) * 2.0 - 1.0;
    gl_Position = vec4(clipSpace, 0, 1);
}`;

let fsText = `
precision highp float;
uniform vec4 u_color;
void main() {
    gl_FragColor = u_color;
}`;
let program;

function testIteration()
{
    let pos = gl.getAttribLocation(program, "a_position");
    if (pos == -1)
        throw "Unused position";    
    for (let i = 0; i < 50; ++i) {
        if (pos != gl.getAttribLocation(program, "a_position"))
            throw "Unexpected position";
        if (!gl.getUniformLocation(program, "u_resolution"))
            throw "Unused resolution";
        if (!gl.getUniformLocation(program, "u_color"))
            throw "Unused color";
    }
}

async function test()
{
    let fs = gl.createShader(gl.FRAGMENT_SHADER);
    gl.shaderSource(fs, fsText);
    gl.compileShader(fs);
    if (!gl.getShaderParameter(fs, gl.COMPILE_STATUS))
        throw "Test error";
    let vs = gl.createShader(gl.VERTEX_SHADER);
    gl.shaderSource(vs, vsText);
    gl.compileShader(vs);
    if (!gl.getShaderParameter(vs, gl.COMPILE_STATUS))
        throw "Test error";
    program = gl.createProgram();
    gl.attachShader(program, vs);
    gl.attachShader(program, fs);
    gl.linkProgram(program);
    var success = gl.getProgramParameter(program, gl.LINK_STATUS);
    if (!success)
        throw `Test error: ${gl.getProgramInfoLog(program)}`;
    gl.useProgram(program);

    testIteration();
    PerfTestRunner.measureRunsPerSecond({
        description: 'Measures performance of WebGL attribute and uniform location getters.',
        run: testIteration
    });
}

test();

</script>
</body>
</html>
